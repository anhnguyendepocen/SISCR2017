---
title: "Module 6: Bayesian Methods for Clinical Research - Computational Methods & Application"
date: "July 24, 2017"
author: "Rebecca Hubbard, Lurdes Inoue"
output:
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  

***


### Install R
- Go to http://cran.rstudio.com/
- Click on the "Download R for [operating system]" link that is appropriate for your operating system and follow the instructions.
- Open R and make sure it works (i.e. that no error messages come up)


### Install RStudio
- Go to http://www.rstudio.com/products/rstudio/download/
- Select the installer that is appropriate for your operating system under "Installers for Supported Platforms" and follow the instructions.
- Open RStudio and make sure it works.

### Install R Packages
- For this module we will be using the _INLA_ and _rjags_ packages
- To use these packages you first need to install them using _install.packages()_
```{r, eval=FALSE}
install.packages("INLA", repos="https://www.math.ntnu.no/inla/R/stable")
install.packages("rjags")
```
- You then need to load these libraries: 
```{r, eval=FALSE}
library(INLA)
library(rjags)
```
```{r, eval=TRUE, echo = FALSE, message = FALSE}
library(INLA)
library(rjags)
library(pander)
```

- After the first time you install the packages on your computer, you will only need to load the libraries in the future 

***

### Introduction to Bayesian Computing

#### Bayesian GLMs using INLA

In this lab, we will conduct an analysis using a Bayesian logistic regression model estimated with INLA. We will use data from the Western Collaborative Group Study (WCGS), a study of the association between cardiovascular health and a variety of risk factors including behavioral pattern conducted in a cohort of male volunteers. The scientific question of interest is whether behavioral pattern is associated with coronary heart disease (CHD). Specifically, investigators hypothesized that men with a "Type A" behavioral pattern would be more likely to experience CHD. However, because this is an observational study design it is important to account for confounding due to many factors such as cigarette smoking and elevated BMI.

We will use the following variables from this data set:

- age Age: age in years

- behpat Behavior pattern: (A1, A2, B3, B4)

- bmi Body mass index 

- chd69 Coronary heart disease : 0 = no; 1 = yes

- chol Cholesterol: mg/100 ml

- dbp Diastolic blood pressure: mm Hg

- dibpat Dichotomous behavior pattern: 0 = Type B; 1 = Type A

- height Height: height in inches

- id Subject ID

- ncigs Smoking: Cigarettes/day

- sbp Systolic blood pressure: mm Hg

- smoke: No = non-smoker; Yes = current smoker

- weight Weight: pounds

- chd01 Binary indicator of CHD: 0 = No; 1 = Yes


You can download the data file and read it into R as follows:
```{r, eval = TRUE}
wcgs <- read.csv("https://raw.githubusercontent.com/rhubb/SISCR2017/master/data/wcgs.csv", header = T)
```

1. First carry out some exploratory data analysis to summarize the distribution of CHD, behavioral pattern, and possible confounders included in the data set. What conclusions do you reach regarding the role that number of cigarettes, BMI, and age may play in the analysis of the association between CHD and behavioral pattern?

    ```{r, eval = TRUE}
#-- univariate tables for categorical variables
table(wcgs$chd69)/sum(table(wcgs$chd69))  
table(wcgs$behpat)/sum(table(wcgs$behpat))
table(wcgs$smoke)/sum(table(wcgs$smoke))

##-- bivariate tables for categorical predictors and CHD
# CHD and behavioral pattern
table(wcgs$behpat,wcgs$chd69)
t(sweep(table(wcgs$chd69,wcgs$behpat),2,rowSums(table(wcgs$behpat,wcgs$chd69)),"/"))
# CHD and smoking
table(wcgs$smoke,wcgs$chd69)
t(sweep(table(wcgs$chd69,wcgs$smoke),2,rowSums(table(wcgs$smoke,wcgs$chd69)),"/"))
# Behavioral pattern and smoking
table(wcgs$behpat,wcgs$smoke)
t(sweep(table(wcgs$smoke,wcgs$behpat),2,rowSums(table(wcgs$behpat,wcgs$smoke)),"/"))

##-- summary statistics for continuous variables by CHD
# Age
tapply(wcgs$age,wcgs$chd69,mean)
tapply(wcgs$age,wcgs$chd69,sd)
boxplot(wcgs$age ~ wcgs$chd69, xlab = "CHD", ylab = "Age (years)")

# BMI
tapply(wcgs$bmi,wcgs$chd69,mean)
tapply(wcgs$bmi,wcgs$chd69,sd)
boxplot(wcgs$bmi ~ wcgs$chd69, xlab = "CHD", ylab = "BMI")

# Number of cigarettes
tapply(wcgs$ncigs,wcgs$chd69,mean)
tapply(wcgs$ncigs,wcgs$chd69,sd)
boxplot(wcgs$ncigs ~ wcgs$chd69, xlab = "CHD", ylab = "Number of Cigarettes")

    ```

2. Next, use Bayesian logistic regression to analyze the association between CHD and behavioral pattern, accounting for possible confounders based on your results from (1). We will explore results using several prior distributions. For each prior distribution can you think of a context in which this prior would be preferred? Compare your results to a standard frequentist logistic regression. How does the interpretation of the results differ for the Bayesian GLM compared to the frequentist GLM?

  a. Normal(0,10) priors 

    ```{r, eval = TRUE}

## -- Normal priors for regression coefficients (with mean=0 and scale=10)
chd.n10 <- inla(chd01~ factor(behpat) + smoke + age, data=wcgs, family = "binomial",
         control.fixed=list(mean.intercept=c(0),prec.intercept=c(1/10),mean=c(0,0),prec=rep(1/10,2)))

chd.n10$summary.fix
## -- Plot posterior densities
plot(chd.n10, plot.prior = TRUE)
    ```
  
  b. Normal(0,0.1) priors

    ```{r, eval = TRUE}

## -- Normal priors for regression coefficients (with mean=0 and scale=0.1), N(0,10) prior for intercept
chd.n01 <- inla(chd01~ factor(behpat) + smoke + age, data=wcgs, family = "binomial",
         control.fixed=list(mean.intercept=c(0),prec.intercept=c(1/10),mean=c(0,0),prec=rep(10,2)))

chd.n01$summary.fix

## -- Plot posterior densities
plot(chd.n01, plot.prior = TRUE)
    ```

  c. Frequentist logistic regression

    ```{r, eval = TRUE}
chd.glm1 <- glm(chd01~ factor(behpat) + smoke + age, data=wcgs, family=binomial)
summary(chd.glm1)
    ```
    
3. Using one of the models you fit in (2) interpret your results.     

    ```{r, eval = TRUE}
## -- Exponentiate results to obtain odds ratios
exp(chd.n10$summary.fix)    
    ```
    
***

### Interim Monitoring of Clinical Trials

